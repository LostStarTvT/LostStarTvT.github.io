<!DOCTYPE html>
<html lang="en">

  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="theme-color" content="#546E7A">

    

    <title>Mybatis：延迟加载策略 &amp; 缓存</title>

    
      
    

    <link rel="canonical" href="www.diaowenjie.cn/2020/05/05/java-Mybatis-four.html">

    
    <meta name="keywords" itemprop="keywords" content="blog,css,html,php">
    <link rel="shortcut icon" sizes="128x128" href="/avatar/favicon.png">

    <meta name="robots" content="noarchive">

   
    <style>
.site-header {
   background-color: #546E7A;
   }
.page-header {
   background: url("https://api.dujin.org/bing/1920.php") no-repeat center; -webkit-background-size: cover; -moz-background-size: cover; -o-background-size: cover; background-size:cover; max-width:100%; margin: auto;text-align: center;margin-bottom:20px;
}
</style>

    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/fade.css">
    <meta name="google-site-verification" content="tb5-LFfZ4ccQdqYC0-JKdEi3uWBF3IFo8PNsDcahigs" />
  </head>
  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    

    
      <a class="site-title" href="/">刁文杰的博客</a>
    

    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#ffffff" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#ffffff" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#ffffff" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
              
              
            
          
            
            
              
                <a class="page-link" href="/Billboard.html">Billboard</a>
              
            
          
            
            
              
                <a class="page-link" href="/about.html">About</a>
              
            
          
            
            
              
                <a class="page-link" href="/archives.html">Archives</a>
              
            
          
            
            
          
            
            
          
            
            
              
                <a class="page-link" href="/links.html">Links</a>
              
            
          
            
            
          
            
            
              
                <a class="page-link" href="/pages/tags.html">Tags</a>
              
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    
    
    
    
    <script>
      var OriginTitile = document.title;
      var titleTime;
      document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
          document.title = '刁文杰的博客 ' + OriginTitile;
          clearTimeout(titleTime);
        }
        else {
          document.title = '刁文杰的博客 ' + OriginTitile;
          titleTime = setTimeout(function() {
            document.title = OriginTitile;
          }, 2000);
        }});

    </script>

    <section class="page-header">
      <h1 class="project-name">Mybatis：延迟加载策略 &amp; 缓存</h1>
      <h2 class="project-tagline"></h2>
      
        <h2 class="project-date">
        <time datetime="2020-05-05T00:00:00+08:00" itemprop="datePublished">
          
          May 5, 2020
        </time>
        
        
          • <span itemprop="author" itemscope itemtype=""><span itemprop="name">刁文杰的博客</span></span>
        
        </h2>
      
    </section>

    <section class="main-content fade">

      <article itemscope itemtype="">

  <header class="post-header">
      <link rel="dns-prefetch" href="//cdn.bootcss.com" />
    <h1 class="post-title" itemprop="name headline">Mybatis：延迟加载策略 &amp; 缓存</h1>
    <p class="post-meta">
      <time datetime="2020-05-05T00:00:00+08:00" itemprop="datePublished">
        
        May 5, 2020
      </time>
      </p>
  </header>
<script type="text/javascript" async
src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  document.getElementsByTagName("img").className="bbb";  
  </script>
  
  <div itemprop="articleBody">
    <blockquote>
  <p>记录Mybatis的延迟加载策略</p>
</blockquote>

<h2 id="目录">目录</h2>
<ul id="markdown-toc">
  <li><a href="#目录" id="markdown-toc-目录">目录</a></li>
  <li><a href="#1延迟加载" id="markdown-toc-1延迟加载">1.延迟加载</a>    <ul>
      <li><a href="#11-一对一实现延迟加载" id="markdown-toc-11-一对一实现延迟加载">1.1 一对一实现延迟加载</a></li>
      <li><a href="#12-一对多延迟加载" id="markdown-toc-12-一对多延迟加载">1.2 一对多延迟加载</a></li>
    </ul>
  </li>
  <li><a href="#2缓存" id="markdown-toc-2缓存">2.缓存</a>    <ul>
      <li><a href="#21-一级缓存" id="markdown-toc-21-一级缓存">2.1 一级缓存</a></li>
      <li><a href="#21-二级缓存" id="markdown-toc-21-二级缓存">2.1 二级缓存</a></li>
    </ul>
  </li>
  <li><a href="#3-注解开发" id="markdown-toc-3-注解开发">3. 注解开发</a>    <ul>
      <li><a href="#31-环境搭建" id="markdown-toc-31-环境搭建">3.1 环境搭建</a></li>
      <li><a href="#32-单表crud" id="markdown-toc-32-单表crud">3.2 单表CRUD</a></li>
      <li><a href="#33-一对一立即查询" id="markdown-toc-33-一对一立即查询">3.3 一对一立即查询</a></li>
      <li><a href="#34-一对多懒加载" id="markdown-toc-34-一对多懒加载">3.4 一对多懒加载</a></li>
      <li><a href="#35-开启二级缓存" id="markdown-toc-35-开启二级缓存">3.5 开启二级缓存</a></li>
    </ul>
  </li>
</ul>
<h1 id="1延迟加载">1.延迟加载</h1>

<p>问题：在一对多中，当我们有一个用户，他有100个账户。</p>

<ol>
  <li>在查询该用户的时候，要不要把关联的账户查出来？</li>
  <li>在查询账户时候，要不要把关联的用户查出来？</li>
</ol>

<p>推论：</p>

<ol>
  <li>在查询用户的时候，用户下的账户信息是什么时候使用什么时候查询。</li>
  <li>在查询账户时，账户的所属用户信息应该是随着账户查询时一起查询出来。</li>
</ol>

<p>在对应的四种表关系中：一对多，多对一，一对一，多对多：</p>

<ol>
  <li>一对多，多对多：通常情况下我们都是采用延迟加载。</li>
  <li>多对一，一对一：通常情况下我们都是采用立即加载。</li>
</ol>

<ul>
  <li>延迟加载
    <ul>
      <li>在真正使用数据时才发起查询，不用的时候不查询，按需加载（懒加载）。</li>
    </ul>
  </li>
  <li>立即加载
    <ul>
      <li>不管用不用，只要一调用方法，马上发起查询。</li>
    </ul>
  </li>
</ul>

<h2 id="11-一对一实现延迟加载">1.1 一对一实现延迟加载</h2>

<p>在真正使用数据时菜发起查询，不用的时候不查询，按需加载（懒加载）</p>

<p>使用一对一的案例进行配置延迟加载：</p>

<p>主要使用的标签为：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--
 配置懒加载。
 一对一的关系映射，配置封装user的内容，
 select 属性指定的内容：查询用户的唯一标识
 column 属性指定的内容：用户根据id查询时，所需要的参数的值。
 表示的含义也就是，当查询到这一行的时候，使用com.diaowenjie.dao.IUserDao.findById这条语句进行查询，并且将uid得值传递进去，这样就是
 不用写复杂的sql语句，而是纯使用java去时下，可以参考前面笔记的一对一纯sql的实现方式。
--&gt;</span>
<span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">"user"</span> <span class="na">column=</span><span class="s">"uid"</span> <span class="na">javaType=</span><span class="s">"user"</span> <span class="na">select=</span><span class="s">"com.diaowenjie.dao.IUserDao.findById"</span><span class="nt">/&gt;</span>
</code></pre></div></div>

<p>1.改造IAccountDao.xml使其进行懒加载</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">"com.diaowenjie.dao.IAccountDao"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--定义role的resultMap--&gt;</span>
    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">"accountUserMap"</span> <span class="na">type=</span><span class="s">"account"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">"id"</span> <span class="na">column=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">"uid"</span> <span class="na">column=</span><span class="s">"uid"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">"money"</span> <span class="na">column=</span><span class="s">"money"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--
        配置懒加载。
        一对一的关系映射，配置封装user的内容，
        select 属性指定的内容：查询用户的唯一标识
        column 属性指定的内容：用户根据id查询时，所需要的参数的值。
        --&gt;</span>
        <span class="nt">&lt;association</span> <span class="na">property=</span><span class="s">"user"</span>  <span class="na">javaType=</span><span class="s">"user"</span> <span class="na">select=</span><span class="s">"com.diaowenjie.dao.IUserDao.findById"</span> <span class="na">column=</span><span class="s">"uid"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>
    <span class="c">&lt;!--查询所有--&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"findAll"</span> <span class="na">resultMap=</span><span class="s">"accountUserMap"</span><span class="nt">&gt;</span>
         SELECT  * FROM account;
    <span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</code></pre></div></div>

<p>2.调用的是IUserDao中的findByID属性</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">"com.diaowenjie.dao.IUserDao"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--根据id查询用户 --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"findById"</span> <span class="na">parameterType=</span><span class="s">"Integer"</span> <span class="na">resultType=</span><span class="s">"user"</span><span class="nt">&gt;</span>
        select * from user where id  = #{id};
    <span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</code></pre></div></div>

<p>3.开启Mybatis懒加载设置</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--配置参数--&gt;</span>
<span class="nt">&lt;settings&gt;</span>
    <span class="c">&lt;!--开启Mybatis支持延迟加载--&gt;</span>
    <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">"lazyLoadingEnabled"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">"aggressiveLazyLoading"</span> <span class="na">value=</span><span class="s">"false"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/settings&gt;</span>
</code></pre></div></div>

<p>对比之前一对一的xml配置文件，其映射关系更加的简洁，但是需要调用其xml中的配置。通过以上便能实现需要进行懒加载。</p>

<h2 id="12-一对多延迟加载">1.2 一对多延迟加载</h2>

<p>原理也是一样，需要哪行查哪行。每显示一行都会获取uid并调用<code class="language-plaintext highlighter-rouge">select="com.diaowenjie.dao.IAccountDao.findAccountByUid" </code>语句去查询需要的用户账号信息，这样的写法其实是比sql语句更好些。</p>

<p>1.改造IUserDao.xml将其实现懒加载</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">"com.diaowenjie.dao.IUserDao"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!--定义user的resultMap--&gt;</span>
    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">"userAccountMap"</span> <span class="na">type=</span><span class="s">"user"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">"id"</span> <span class="na">column=</span><span class="s">"id"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">"username"</span> <span class="na">column=</span><span class="s">"username"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">"address"</span> <span class="na">column=</span><span class="s">"address"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">"sex"</span> <span class="na">column=</span><span class="s">"sex"</span><span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">"birthday"</span> <span class="na">column=</span><span class="s">"birthday"</span><span class="nt">/&gt;</span>
        <span class="c">&lt;!--配置user对象中accounts集合的映射--&gt;</span>
        <span class="nt">&lt;collection</span> <span class="na">property=</span><span class="s">"accounts"</span> <span class="na">ofType=</span><span class="s">"account"</span>  <span class="na">select=</span><span class="s">"com.diaowenjie.dao.IAccountDao.findAccountByUid"</span> <span class="na">column=</span><span class="s">"id"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;/resultMap&gt;</span>
    <span class="c">&lt;!--查询所有--&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"findAll"</span> <span class="na">resultMap=</span><span class="s">"userAccountMap"</span><span class="nt">&gt;</span>
        SELECT * FROM user;
    <span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</code></pre></div></div>

<p>2.调用的是IAccountDao.xml中的查询方法</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--根据用户id查询列表--&gt;</span>
<span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"findAccountByUid"</span> <span class="na">resultType=</span><span class="s">"account"</span><span class="nt">&gt;</span>
    select *  from account where uid = #{uid};
<span class="nt">&lt;/select&gt;</span>
</code></pre></div></div>

<p>然后便实现了多对多的懒加载，这种加载可以通过查看日志日志如下：</p>

<p><a href="https://pic.tyzhang.top/image/dHXK"><img src="https://pic.tyzhang.top/images/2020/05/06/lazymul4mul.png" alt="lazymul4mul.png" /></a></p>

<p>可以看出是在需要的时候，展示哪一行就调用该行的数据去进行执行，并且是简单的sql语句，传递的是该行的参数，uid。</p>

<h1 id="2缓存">2.缓存</h1>

<ul>
  <li>什么是缓存？
    <ul>
      <li>存在于内存中的临时数据。</li>
    </ul>
  </li>
  <li>为什么使用缓存？
    <ul>
      <li>减少和数据库的交互次数，提高执行效率</li>
    </ul>
  </li>
  <li>适用缓存的
    <ul>
      <li>经常查询并且不经常改变的。</li>
      <li>数据的正确与否对最终结果影响不大的、</li>
    </ul>
  </li>
  <li>不适应缓存的
    <ul>
      <li>经常改变的数据</li>
      <li>数据的正确与否对最终结果影响很大的</li>
      <li>例如：商品的库存，银行的汇率，股市的牌价。</li>
    </ul>
  </li>
</ul>

<h2 id="21-一级缓存">2.1 一级缓存</h2>

<p>它指的是Mybatis中SQLSession对象的缓存。当我们执行查询之后，查询的结果会同时存入到SqlSession为我们提供的一块区域中。该区域的结构是一个Map，当我们再次查询同样的数据，mybatis会先去SQLSession中查询是否有，有的话就直接拿出来用。</p>

<p>当SqlSession对象消失时，mybatis的一级缓存也就消失了。</p>

<p>同一个session中的话，其查询的用户数据是同一个。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//测试一级缓存</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFirstLevelCache</span><span class="o">(){</span>
    <span class="nc">User</span> <span class="n">user1</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">41</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user1</span><span class="o">);</span>

    <span class="nc">User</span> <span class="n">user2</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">41</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user2</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user1</span> <span class="o">==</span> <span class="n">user2</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>输出的结果如下：可以看出是同一个对象。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>com.diaowenjie.domain.User@5c669da8
com.diaowenjie.domain.User@5c669da8
<span class="nb">true</span>
</code></pre></div></div>

<p>当进行关闭session重新打开时候的输出：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//测试缓存。</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFirstLevelCache</span><span class="o">(){</span>
    <span class="nc">User</span> <span class="n">user1</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">41</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user1</span><span class="o">);</span>

    <span class="n">sqlSession</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    
    <span class="c1">//再次获取sqlSession对象</span>
    <span class="n">sqlSession</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span>
    <span class="n">userDao</span> <span class="o">=</span> <span class="n">sqlSession</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="nc">IUserDao</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nc">User</span> <span class="n">user2</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">41</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user2</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user1</span> <span class="o">==</span> <span class="n">user2</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>此时输出的结果就是两个二者并不是一致的。从日志上看，也是进行了两次的查询操作。</p>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="n">Created</span> <span class="n">connection</span> <span class="mf">1324829744.</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="n">Setting</span> <span class="n">autocommit</span> <span class="n">to</span> <span class="n">false</span> <span class="n">on</span> <span class="n">JDBC</span> <span class="n">Connection</span> <span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">mysql</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">JDBC4Connection</span><span class="o">@</span><span class="mi">4</span><span class="n">ef74c30</span><span class="p">]</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="o">:</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">user</span> <span class="n">where</span> <span class="n">id</span> <span class="o">=</span> <span class="o">?</span><span class="p">;</span>   
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="o">:</span> <span class="o">==&gt;</span> <span class="n">Parameters</span><span class="o">:</span> <span class="mi">41</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="o">:</span> <span class="o">&lt;==</span>      <span class="n">Total</span><span class="o">:</span> <span class="mi">1</span>  
<span class="n">com</span><span class="p">.</span><span class="n">diaowenjie</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">User</span><span class="o">@</span><span class="mi">7</span><span class="n">cb502c</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="n">Resetting</span> <span class="n">autocommit</span> <span class="n">to</span> <span class="n">true</span> <span class="n">on</span> <span class="n">JDBC</span> <span class="n">Connection</span> <span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">mysql</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">JDBC4Connection</span><span class="o">@</span><span class="mi">4</span><span class="n">ef74c30</span><span class="p">]</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="o">:</span> <span class="n">Closing</span> <span class="n">JDBC</span> <span class="n">Connection</span> <span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">mysql</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">JDBC4Connection</span><span class="o">@</span><span class="mi">4</span><span class="n">ef74c30</span><span class="p">]</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="o">:</span> <span class="n">Returned</span> <span class="n">connection</span> <span class="mi">1324829744</span> <span class="n">to</span> <span class="n">pool</span><span class="p">.</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="o">:</span> <span class="n">Opening</span> <span class="n">JDBC</span> <span class="n">Connection</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="o">:</span> <span class="n">Checked</span> <span class="n">out</span> <span class="n">connection</span> <span class="mi">1324829744</span> <span class="n">from</span> <span class="n">pool</span><span class="p">.</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="n">Setting</span> <span class="n">autocommit</span> <span class="n">to</span> <span class="n">false</span> <span class="n">on</span> <span class="n">JDBC</span> <span class="n">Connection</span> <span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">mysql</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">JDBC4Connection</span><span class="o">@</span><span class="mi">4</span><span class="n">ef74c30</span><span class="p">]</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="o">:</span> <span class="o">==&gt;</span>  <span class="n">Preparing</span><span class="o">:</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">user</span> <span class="n">where</span> <span class="n">id</span> <span class="o">=</span> <span class="o">?</span><span class="p">;</span>   
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span> <span class="o">:</span> <span class="o">==&gt;</span> <span class="n">Parameters</span><span class="o">:</span> <span class="mi">41</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="o">&lt;==</span>      <span class="n">Total</span><span class="o">:</span> <span class="mi">1</span>  
<span class="n">com</span><span class="p">.</span><span class="n">diaowenjie</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">User</span><span class="o">@</span><span class="mi">1</span><span class="n">b8a29df</span>
<span class="n">false</span>
</code></pre></div></div>

<p>也可以使用刷新缓存的方式进行：和以上的效果是一致的，</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFirstLevelCache</span><span class="o">(){</span>
    <span class="nc">User</span> <span class="n">user1</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">41</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user1</span><span class="o">);</span>

    <span class="n">sqlSession</span><span class="o">.</span><span class="na">clearCache</span><span class="o">();</span> <span class="c1">//刷新缓存</span>
    <span class="n">userDao</span> <span class="o">=</span> <span class="n">sqlSession</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="nc">IUserDao</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nc">User</span> <span class="n">user2</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">41</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user2</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user1</span> <span class="o">==</span> <span class="n">user2</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>一级缓存的范围，当调用SQLSession的修改，添加，删除，commit()，close()等方法时，就会清除一级缓存。</p>

<p>如下所示，在两次查询中插入一个更新操作，然后日志如下并且两个对象也不一样。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//测试缓存。</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testClearCache</span><span class="o">(){</span>
    <span class="nc">User</span> <span class="n">user1</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">41</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user1</span><span class="o">);</span>
	<span class="c1">//更新用户</span>
    <span class="n">user1</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"cccc"</span><span class="o">);</span>
    <span class="n">user1</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="s">"cccc"</span><span class="o">);</span>
    <span class="n">userDao</span><span class="o">.</span><span class="na">updateUser</span><span class="o">(</span><span class="n">user1</span><span class="o">);</span>

    <span class="nc">User</span> <span class="n">user2</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">41</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user2</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user1</span> <span class="o">==</span> <span class="n">user2</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="n">Opening</span> <span class="n">JDBC</span> <span class="n">Connection</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="n">Created</span> <span class="n">connection</span> <span class="mf">1324829744.</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="n">Setting</span> <span class="n">autocommit</span> <span class="n">to</span> <span class="n">false</span> <span class="n">on</span> <span class="n">JDBC</span> <span class="n">Connection</span> <span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">mysql</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">JDBC4Connection</span><span class="o">@</span><span class="mi">4</span><span class="n">ef74c30</span><span class="p">]</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="o">==&gt;</span>  <span class="n">Preparing</span><span class="o">:</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">user</span> <span class="n">where</span> <span class="n">id</span> <span class="o">=</span> <span class="o">?</span><span class="p">;</span>   
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="o">==&gt;</span> <span class="n">Parameters</span><span class="o">:</span> <span class="mi">41</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="o">&lt;==</span>      <span class="n">Total</span><span class="o">:</span> <span class="mi">1</span>  
<span class="n">com</span><span class="p">.</span><span class="n">diaowenjie</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">User</span><span class="o">@</span><span class="mi">7</span><span class="n">cb502c</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="o">==&gt;</span>  <span class="n">Preparing</span><span class="o">:</span> <span class="n">update</span> <span class="n">user</span> <span class="n">set</span> <span class="n">username</span> <span class="o">=</span> <span class="o">?</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="o">?</span> <span class="n">where</span> <span class="n">id</span> <span class="o">=</span> <span class="o">?</span><span class="p">;</span>   
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="o">==&gt;</span> <span class="n">Parameters</span><span class="o">:</span> <span class="n">cccc</span><span class="p">(</span><span class="n">String</span><span class="p">),</span> <span class="n">cccc</span><span class="p">(</span><span class="n">String</span><span class="p">),</span> <span class="mi">41</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="o">&lt;==</span>    <span class="n">Updates</span><span class="o">:</span> <span class="mi">1</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="o">==&gt;</span>  <span class="n">Preparing</span><span class="o">:</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">user</span> <span class="n">where</span> <span class="n">id</span> <span class="o">=</span> <span class="o">?</span><span class="p">;</span>   
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="o">==&gt;</span> <span class="n">Parameters</span><span class="o">:</span> <span class="mi">41</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="o">&lt;==</span>      <span class="n">Total</span><span class="o">:</span> <span class="mi">1</span>  
<span class="n">com</span><span class="p">.</span><span class="n">diaowenjie</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">User</span><span class="o">@</span><span class="mi">4</span><span class="n">fbe37eb</span>
<span class="n">false</span>
</code></pre></div></div>

<p>输出的结果为false。</p>

<h2 id="21-二级缓存">2.1 二级缓存</h2>

<p>它指的是mybatis中的sqlSessionFatory对象的缓存，由同一个SqlSessionFactory对象创建的SQLSession共享缓存。<strong>一级缓存关闭SQLSession时候就会重新查询，二级缓存表示关闭SQLSession也不会重新查询而是使用缓存。</strong></p>

<p><a href="https://pic.tyzhang.top/image/dX2f"><img src="https://pic.tyzhang.top/images/2020/05/07/secondLevelCache.png" alt="secondLevelCache.png" /></a></p>

<p>二级缓存的使用步骤；</p>

<ol>
  <li>
    <p>让mybatis框架支持二级缓存(在sqlMapConfig.xml中配置)。</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!--配置参数--&gt;</span>
<span class="nt">&lt;settings&gt;</span>
    <span class="c">&lt;!--开启缓存支持--&gt;</span>
    <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">"cacheEnabled"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/settings&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>让当前的映射文件支持二级缓存(在IUserDao.xml中配置)。</p>
  </li>
  <li>
    <p>让当前的操作支持二级缓存(在select标签中配置)。</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">"com.diaowenjie.dao.IUserDao"</span><span class="nt">&gt;</span>
    <span class="c">&lt;!--开启user支持二级缓存--&gt;</span>
    <span class="nt">&lt;cache/&gt;</span>
    <span class="c">&lt;!--根据id查询用户 开启cache=true --&gt;</span>
    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">"findById"</span> <span class="na">parameterType=</span><span class="s">"Integer"</span> <span class="na">resultType=</span><span class="s">"user"</span> <span class="na">useCache=</span><span class="s">"true"</span><span class="nt">&gt;</span>
        select * from user where id  = #{id};
    <span class="nt">&lt;/select&gt;</span>
<span class="nt">&lt;/mapper&gt;</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>经过以上的配置以后进行测试：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//测试缓存。开启两个sqlSession进行查询数据。</span>
<span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFirstLevelCache</span><span class="o">(){</span>
    <span class="nc">SqlSession</span> <span class="n">sqlSession1</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span>
    <span class="nc">IUserDao</span> <span class="n">dao1</span> <span class="o">=</span> <span class="n">sqlSession1</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="nc">IUserDao</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">User</span> <span class="n">user1</span> <span class="o">=</span> <span class="n">dao1</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">41</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user1</span><span class="o">);</span>
    <span class="n">sqlSession1</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

    <span class="nc">SqlSession</span> <span class="n">sqlSession2</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span>
    <span class="nc">IUserDao</span> <span class="n">dao2</span> <span class="o">=</span> <span class="n">sqlSession2</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="nc">IUserDao</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">User</span> <span class="n">user2</span> <span class="o">=</span> <span class="n">dao2</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">41</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user2</span><span class="o">);</span>
    <span class="n">sqlSession1</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user1</span> <span class="o">==</span> <span class="n">user2</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>此时输出的日志文件</p>

<div class="language-verilog highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="n">Created</span> <span class="n">connection</span> <span class="mf">1200470358.</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="n">Setting</span> <span class="n">autocommit</span> <span class="n">to</span> <span class="n">false</span> <span class="n">on</span> <span class="n">JDBC</span> <span class="n">Connection</span> <span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">mysql</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">JDBC4Connection</span><span class="o">@</span><span class="mi">478</span><span class="n">db956</span><span class="p">]</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="o">==&gt;</span>  <span class="n">Preparing</span><span class="o">:</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">user</span> <span class="n">where</span> <span class="n">id</span> <span class="o">=</span> <span class="o">?</span><span class="p">;</span>   
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="o">==&gt;</span> <span class="n">Parameters</span><span class="o">:</span> <span class="mi">41</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="o">&lt;==</span>      <span class="n">Total</span><span class="o">:</span> <span class="mi">1</span>  
<span class="n">com</span><span class="p">.</span><span class="n">diaowenjie</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">User</span><span class="o">@</span><span class="mi">2</span><span class="n">b175c00</span>
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="n">Resetting</span> <span class="n">autocommit</span> <span class="n">to</span> <span class="n">true</span> <span class="n">on</span> <span class="n">JDBC</span> <span class="n">Connection</span> <span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">mysql</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">JDBC4Connection</span><span class="o">@</span><span class="mi">478</span><span class="n">db956</span><span class="p">]</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="n">Closing</span> <span class="n">JDBC</span> <span class="n">Connection</span> <span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">mysql</span><span class="p">.</span><span class="n">jdbc</span><span class="p">.</span><span class="n">JDBC4Connection</span><span class="o">@</span><span class="mi">478</span><span class="n">db956</span><span class="p">]</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="n">Returned</span> <span class="n">connection</span> <span class="mi">1200470358</span> <span class="n">to</span> <span class="n">pool</span><span class="p">.</span>  
<span class="p">[</span><span class="n">DEBUG</span><span class="p">]</span><span class="o">:</span> <span class="n">Cache</span> <span class="n">Hit</span> <span class="n">Ratio</span> <span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">diaowenjie</span><span class="p">.</span><span class="n">dao</span><span class="p">.</span><span class="n">IUserDao</span><span class="p">]</span><span class="o">:</span> <span class="mf">0.5</span>  
<span class="n">com</span><span class="p">.</span><span class="n">diaowenjie</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">User</span><span class="o">@</span><span class="mi">10</span><span class="n">f7f7de</span>
<span class="n">false</span>
</code></pre></div></div>

<p>虽然对比结果为false，是因为二级缓存只存储数据不存储对象的原因。但是日志文件显示只查询了一次，并且有cache hit ratio的字样。</p>

<h1 id="3-注解开发">3. 注解开发</h1>

<h2 id="31-环境搭建">3.1 环境搭建</h2>

<p>主要就是涉及到一个配置文件:其中这里的注解与配置文件与spring的不一样，其实和使用xml的差不多，无需指定开启注解扫描。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="cp">&lt;!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd"&gt;</span>
<span class="c">&lt;!--mybatis主配置文件--&gt;</span>
<span class="nt">&lt;configuration&gt;</span>
    <span class="c">&lt;!-- 读取数据库配置文件 --&gt;</span>
    <span class="nt">&lt;properties</span> <span class="na">resource=</span><span class="s">"jdbcConfig.properties"</span><span class="nt">/&gt;</span>

    <span class="c">&lt;!--只能配置domain中的别名--&gt;</span>
    <span class="nt">&lt;typeAliases&gt;</span>
        <span class="c">&lt;!--用户指定要配置别名的包，当指定以后，该包下的实体类都会注册别名，并且类名就是别名，不在区分大小写--&gt;</span>
        <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">"com.diaowenjie.domain"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/typeAliases&gt;</span>

    <span class="c">&lt;!--配置环境--&gt;</span>
    <span class="nt">&lt;environments</span> <span class="na">default=</span><span class="s">"mysql"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- 配置mysql的环境--&gt;</span>
        <span class="nt">&lt;environment</span> <span class="na">id=</span><span class="s">"mysql"</span><span class="nt">&gt;</span>
            <span class="c">&lt;!-- 配置事务的类型--&gt;</span>
            <span class="nt">&lt;transactionManager</span> <span class="na">type=</span><span class="s">"JDBC"</span><span class="nt">/&gt;</span>
            <span class="c">&lt;!-- 配置数据源(连接池)--&gt;</span>
            <span class="nt">&lt;dataSource</span> <span class="na">type=</span><span class="s">"POOLED"</span><span class="nt">&gt;</span>
                <span class="c">&lt;!-- 配置连接数据的四个基本信息--&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"driver"</span> <span class="na">value=</span><span class="s">"${jdbc.driver}"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"url"</span> <span class="na">value=</span><span class="s">"${jdbc.url}"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"username"</span> <span class="na">value=</span><span class="s">"${jdbc.username}"</span><span class="nt">/&gt;</span>
                <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">value=</span><span class="s">"${jdbc.password}"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/dataSource&gt;</span>
        <span class="nt">&lt;/environment&gt;</span>
    <span class="nt">&lt;/environments&gt;</span>

    <span class="c">&lt;!--指定带有注解的dao接口所在位置--&gt;</span>
    <span class="nt">&lt;mappers&gt;</span>
        <span class="c">&lt;!-- package标签是用于指定dao接口所在的包，当指定了之后就不需要在写mapper以及resource或者class了--&gt;</span>
        <span class="nt">&lt;package</span> <span class="na">name=</span><span class="s">"com.diaowenjie.dao"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/mappers&gt;</span>

<span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></div>

<p>user实体类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">username</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">address</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">sex</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">birthday</span><span class="o">;</span>
    <span class="c1">//set and get to string</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="32-单表crud">3.2 单表CRUD</h2>

<p>主要写一下核心算法， 具体的实现见xml的crud。</p>

<p>对应的接口注解IUserDao.java</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 在myBatis中只对crud共有四个注解
 * @Select @Insert @Update @Delete
 */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IUserDao</span> <span class="o">{</span>

    <span class="cm">/**
     * 查询所有用户
     * @return
     */</span>
    <span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from user"</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>

    <span class="cm">/**
     * 保存用户
     * @param user
     */</span>
    <span class="nd">@Insert</span><span class="o">(</span><span class="s">"insert into user (username,address,sex,birthday) values (#{username},#{address},#{sex},#{birthday})"</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">saveUser</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="cm">/**
     * 更新用户
     * @param user
     */</span>
    <span class="nd">@Update</span><span class="o">(</span><span class="s">"update user set username=#{username},address=#{address},sex=#{sex},birthday=#{birthday} where id = #{id}"</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">updateUser</span><span class="o">(</span><span class="nc">User</span> <span class="n">user</span><span class="o">);</span>

    <span class="cm">/**
     * 删除用户
     * @param userId
     */</span>
    <span class="nd">@Delete</span><span class="o">(</span><span class="s">"delete from user where id = #{id}"</span><span class="o">)</span>
    <span class="kt">void</span> <span class="nf">deleteUser</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">userId</span><span class="o">);</span>

    <span class="cm">/**
     * 根据id查询用户
     * @param userId
     * @return
     */</span>
    <span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from user where id  = #{id}"</span><span class="o">)</span>
    <span class="nc">User</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">userId</span><span class="o">);</span>

    <span class="cm">/**
     * 根据名称模糊查询用户
     * @param username
     * @return
     */</span>
    <span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from user where username like #{name}"</span><span class="o">)</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findByName</span><span class="o">(</span><span class="nc">String</span> <span class="n">username</span><span class="o">);</span>

    <span class="cm">/**
     *  使用聚合函数查询所有
     * @return
     */</span>
    <span class="nd">@Select</span><span class="o">(</span><span class="s">"select count(id) from user;"</span><span class="o">)</span>
    <span class="kt">int</span> <span class="nf">findTotal</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>对应的测试类：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnnotationCRUDTest</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">InputStream</span> <span class="n">in</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">SqlSession</span> <span class="n">sqlSession</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">IUserDao</span> <span class="n">userDao</span><span class="o">;</span>

    <span class="c1">//运行的初始化方法</span>
    <span class="nd">@Before</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">//1.读取配置文件</span>
        <span class="n">in</span> <span class="o">=</span> <span class="nc">Resources</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">"sqlMapConfig.xml"</span><span class="o">);</span>
        <span class="c1">//2.创建sqlSessionFactory工厂</span>
        <span class="nc">SqlSessionFactoryBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SqlSessionFactoryBuilder</span><span class="o">();</span>
        <span class="nc">SqlSessionFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="c1">//3.使用工厂生产SQLSession对象</span>
        <span class="n">sqlSession</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">openSession</span><span class="o">();</span>
        <span class="c1">//4.使用SQLSession创建Dao接口代理对象</span>
        <span class="n">userDao</span> <span class="o">=</span> <span class="n">sqlSession</span><span class="o">.</span><span class="na">getMapper</span><span class="o">(</span><span class="nc">IUserDao</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//运行的结束方法</span>
    <span class="nd">@After</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="c1">//提交事务  不添加这一句数据写不进去 会回滚</span>
        <span class="n">sqlSession</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
        <span class="c1">//6.释放资源</span>
        <span class="n">sqlSession</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">in</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span>  <span class="nf">testFindAll</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

        <span class="c1">//5.使用代理对象执行方法</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">User</span> <span class="nl">user:</span><span class="n">users</span><span class="o">){</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSave</span><span class="o">(){</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"测试"</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="s">"河南郑州"</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setSex</span><span class="o">(</span><span class="s">"男"</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setBirthday</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>
        <span class="c1">//5.执行保存用户</span>
        <span class="n">userDao</span><span class="o">.</span><span class="na">saveUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//更新用户</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testUpdate</span><span class="o">(){</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">User</span><span class="o">();</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">49</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setUsername</span><span class="o">(</span><span class="s">"测试"</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setAddress</span><span class="o">(</span><span class="s">"河南郑州"</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setSex</span><span class="o">(</span><span class="s">"女"</span><span class="o">);</span>
        <span class="n">user</span><span class="o">.</span><span class="na">setBirthday</span><span class="o">(</span><span class="k">new</span> <span class="nc">Date</span><span class="o">());</span>

        <span class="n">userDao</span><span class="o">.</span><span class="na">updateUser</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//删除用户</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testDelete</span><span class="o">(){</span>
        <span class="n">userDao</span><span class="o">.</span><span class="na">deleteUser</span><span class="o">(</span><span class="mi">49</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//根据id查询用户</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFindById</span><span class="o">(){</span>
        <span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">49</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">//根据username查询</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFindByName</span><span class="o">(){</span>
        <span class="c1">//因为是模糊查询，所有需要提供%</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findByName</span><span class="o">(</span><span class="s">"%王%"</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">User</span> <span class="nl">user:</span><span class="n">users</span><span class="o">){</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">//测试查询总记录条数</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testFindTotal</span><span class="o">(){</span>
        <span class="nc">Integer</span> <span class="n">total</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findTotal</span><span class="o">();</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">total</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong>表名称与实体类属性名称不一致时，需要更改:</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 查询所有用户
 * @return
 */</span>
<span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from user"</span><span class="o">)</span>
<span class="nd">@Results</span><span class="o">(</span><span class="n">id</span> <span class="o">=</span> <span class="s">"userMap"</span><span class="o">,</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span>
    <span class="nd">@Result</span><span class="o">(</span><span class="n">id</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">property</span> <span class="o">=</span> <span class="s">"userId"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">),</span>
    <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"userName"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"username"</span><span class="o">),</span>
    <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"userBirthday"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"birthday"</span><span class="o">),</span>
    <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"userSex"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"sex"</span><span class="o">),</span>
    <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"userAddress"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"address"</span><span class="o">),</span>
<span class="o">})</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">@Results</code> 注解用于定义映射结果集，相当于标签 。其中，id 属性为唯一标识。value 属性用于接收 <code class="language-plaintext highlighter-rouge">@Result[]</code> 注解类型的数组。</li>
  <li><code class="language-plaintext highlighter-rouge">@Result</code> 注解用于定义映射关系，相当于标签。其中，id 属性指定主键。property 属性指定实体类的属性名，column 属性指定数据库表中对应的列。</li>
  <li><code class="language-plaintext highlighter-rouge">@ResultMap</code> 注解用于引用 <code class="language-plaintext highlighter-rouge">@Results</code> 定义的映射结果集，避免了重复定义映射结果集。</li>
</ul>

<p>此时通过id其他的方法也能直接的引用上面的对应关系</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 根据id查询用户
 * @param userId
 * @return
 */</span>
<span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from user where id  = #{id}"</span><span class="o">)</span>
<span class="c1">//@ResultMap(value = {"userMap"}) //标准写法</span>
<span class="nd">@ResultMap</span><span class="o">(</span><span class="s">"userMap"</span><span class="o">)</span> <span class="c1">//简略写法</span>
<span class="nc">User</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">userId</span><span class="o">);</span>
</code></pre></div></div>

<h2 id="33-一对一立即查询">3.3 一对一立即查询</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Account</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">uid</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Double</span> <span class="n">money</span><span class="o">;</span>

    <span class="c1">//多对一(mybatis中称之为一对一)的映射，一个账户只能属于一个用户</span>
    <span class="kd">private</span> <span class="nc">User</span> <span class="n">user</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">userId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userAddress</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userSex</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">userBirthday</span><span class="o">;</span>  
    
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IAccountDao</span> <span class="o">{</span>
    <span class="cm">/**
     *  查询所有账户 并且获取每个账户所属的用户信息
     * @return
     */</span>
    <span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from account"</span><span class="o">)</span>
    <span class="nd">@Results</span><span class="o">(</span><span class="n">id</span><span class="o">=</span><span class="s">"accountMap"</span><span class="o">,</span> <span class="n">value</span><span class="o">={</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">id</span><span class="o">=</span><span class="kc">true</span><span class="o">,</span> <span class="n">column</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">,</span> <span class="n">property</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">),</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">column</span> <span class="o">=</span> <span class="s">"uid"</span><span class="o">,</span> <span class="n">property</span> <span class="o">=</span> <span class="s">"uid"</span><span class="o">),</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">column</span> <span class="o">=</span> <span class="s">"money"</span><span class="o">,</span> <span class="n">property</span> <span class="o">=</span> <span class="s">"money"</span><span class="o">),</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"user"</span><span class="o">,</span> <span class="n">column</span> <span class="o">=</span> <span class="s">"uid"</span><span class="o">,</span>
                    <span class="n">one</span><span class="o">=</span><span class="nd">@One</span><span class="o">(</span><span class="n">select</span><span class="o">=</span><span class="s">"com.diaowenjie.dao.IUserDao.findById"</span><span class="o">,</span> <span class="c1">//调用IUserDao方法</span>
                            <span class="n">fetchType</span><span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">EAGER</span><span class="o">))</span>
    <span class="o">})</span>
    <span class="c1">// @one 表示一对一</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Account</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">@One</code> 注解相当于标签 ，是多表查询的关键，在注解中用来指定子查询返回单一对象。其中，select 属性指定用于查询的接口方法，fetchType 属性用于指定立即加载或延迟加载，分别对应 FetchType.EAGER 和 FetchType.LAZY。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IUserDao</span> <span class="o">{</span>
    <span class="cm">/**
     * 根据id查询用户
     * @param userId
     * @return
     */</span>
    <span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from user where id  = #{id}"</span><span class="o">)</span>
    <span class="nd">@Results</span><span class="o">(</span><span class="n">id</span> <span class="o">=</span> <span class="s">"userMap"</span><span class="o">,</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">id</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">property</span> <span class="o">=</span> <span class="s">"userId"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">),</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"userName"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"username"</span><span class="o">),</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"userBirthday"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"birthday"</span><span class="o">),</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"userSex"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"sex"</span><span class="o">),</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"userAddress"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"address"</span><span class="o">),</span>
    <span class="o">})</span>
    <span class="nc">User</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">userId</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="34-一对多懒加载">3.4 一对多懒加载</h2>

<p>使用的是一个用户有多个账户测试</p>

<p>1.用户的实体类改造</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="nc">Integer</span> <span class="n">userId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userName</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userAddress</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">userSex</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Date</span> <span class="n">userBirthday</span><span class="o">;</span>

    <span class="c1">//一对多映射关系：一个用户对应多个账户</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Account</span><span class="o">&gt;</span> <span class="n">accounts</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>2.IUserDao.java改造，使用懒加载查询数据</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IUserDao</span> <span class="o">{</span>
    <span class="cm">/**
     * 查询所有用户
     * @return
     */</span>
    <span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from user"</span><span class="o">)</span>
    <span class="nd">@Results</span><span class="o">(</span><span class="n">id</span> <span class="o">=</span> <span class="s">"userMap"</span><span class="o">,</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">id</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">property</span> <span class="o">=</span> <span class="s">"userId"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">),</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"userName"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"username"</span><span class="o">),</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"userBirthday"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"birthday"</span><span class="o">),</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"userSex"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"sex"</span><span class="o">),</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"userAddress"</span><span class="o">,</span><span class="n">column</span> <span class="o">=</span> <span class="s">"address"</span><span class="o">),</span>
            <span class="nd">@Result</span><span class="o">(</span><span class="n">property</span> <span class="o">=</span> <span class="s">"accounts"</span><span class="o">,</span> <span class="n">column</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">,</span>
                    <span class="n">many</span><span class="o">=</span><span class="nd">@Many</span><span class="o">(</span><span class="n">select</span> <span class="o">=</span> <span class="s">"com.diaowenjie.dao.IAccountDao.findAccountByUid"</span><span class="o">,</span>
                            <span class="n">fetchType</span> <span class="o">=</span> <span class="nc">FetchType</span><span class="o">.</span><span class="na">LAZY</span><span class="o">))</span>
    <span class="o">})</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findAll</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>3.因为需要查询用户账户，所以需要在账户中添加一个按照用户id查找账户的方法</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 根据用户id查询账户信息
 * @param userId
 * @return
*/</span>
<span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from account where uid = #{userId}"</span><span class="o">)</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Account</span><span class="o">&gt;</span> <span class="nf">findAccountByUid</span><span class="o">(</span><span class="nc">Integer</span> <span class="n">userId</span><span class="o">);</span>
</code></pre></div></div>

<p>然后是测试类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span>  <span class="nf">testFindAll</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">IOException</span> <span class="o">{</span>

    <span class="c1">//5.使用代理对象执行方法</span>
    <span class="nc">List</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">users</span> <span class="o">=</span> <span class="n">userDao</span><span class="o">.</span><span class="na">findAll</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="nc">User</span> <span class="nl">user:</span><span class="n">users</span><span class="o">){</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getAccounts</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>此时便能够查询出相应的结果</p>

<h2 id="35-开启二级缓存">3.5 开启二级缓存</h2>

<p>1.开启配置</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;settings&gt;</span>
    <span class="c">&lt;!-- 开启缓存 --&gt;</span>
    <span class="nt">&lt;setting</span> <span class="na">name=</span><span class="s">"cacheEnabled"</span> <span class="na">value=</span><span class="s">"true"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/settings&gt;</span>
</code></pre></div></div>

<p>2.dao类上添加注释，</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@CacheNamespace</span><span class="o">(</span><span class="n">blocking</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IUserDao</span> <span class="o">{</span>
	<span class="c1">// .....</span>
<span class="o">}</span>
</code></pre></div></div>

<p>终于学完..</p>

  </div>

    
<footer>
    <div style="color: #B0BEC5">标签：
    
    <a class="tag" style="color: #E91E63;font-weight:bold" href="/pages/tags#java">#java</a>
    
  </div>
</footer>






  
  
  

  
  
</article>


      <footer class="site-footer">
        <!-- <span class="site-footer-owner"> 刁文杰的博客©2018-2019.</span> -->
        
      <center>
          <span class="site-footer-credits">刁文杰的博客©2018-2020.</span><br>
          <!-- <span class="site-footer-credits" style="font-size:12px">Already <span id="sitetime"></span> days.</span><br> -->
          <!-- <span class="site-footer-credits" href>浙ICP备2020039014号</span><br> -->
          <a href="http://beian.miit.gov.cn/" class="site-footer-credits"> 浙ICP备2020039014号</a> <br>
      </center>

     
        

      </footer>
    </section>

    

    
    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      inlineMath: [['$','$']]
    }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>


      <script>
          ajax()
  function ajax(option){
    var xhr = null;
    if(window.XMLHttpRequest){
      xhr = new window.XMLHttpRequest();
    }else{ // ie
      xhr = new ActiveObject("Microsoft")
    }
    xhr.open("get","");
    xhr.send(null);
    xhr.onreadystatechange = function(){
      var time = null,
          curDate = null;
      if(xhr.readyState===2){
        // Get time
        time = xhr.getResponseHeader("Date");
        console.log(xhr.getAllResponseHeaders())
        curDate = new Date(time);
        document.getElementById("sitetime").innerHTML = (parseInt((((curDate.getTime() / 1000) - 1571133419 ) / 86400 )));
        
      }
    }
  }
      </script>
      
      <script src = '/assets/js/instantclick.min.js' data-no-instant></script>
      <script data-no-instant>InstantClick.init();</script>
      
  </body>
</html>
