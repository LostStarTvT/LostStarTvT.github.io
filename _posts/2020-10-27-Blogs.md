---
layout: post
title: 转移博客到阿里云
tags: java

---

> 记录将博客从GitPages移植到服务器上。

# 目录

* 目录
{:toc}
# Jekyll

使用RVM进行安装Jekyll环境

```shell
gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB

curl -sSL https://get.rvm.io | bash -s stable

source /etc/profile.d/rvm.sh
```

安装完成以后查看版本

```shell
rvm -v
```

```shell
# 输出
rvm 1.29.10 (latest) by Michal Papis, Piotr Kuczynski, Wayne E. Seguin [https://rvm.io]
```

选择安装的ruby的版本：

```shell
rvm install 2.7
```

等待安装完成以后便可以查看相应的版本。

```shell
ruby -v
# ruby 2.7.0p0 (2019-12-25 revision 647ee6f091) [x86_64-linux]

gem -v
# 3.1.2
```

更新gem

```shell
gem update --system
```

## 安装jekyll

尝试安装 jekyll，大概率会出现找不到库

```shell
gem install jekyll bundler
# ERROR:  Could not find a valid gem 'jekyll' (>= 0) in any repository
```

修改源

```shell
# 查看所有源
gem sources -l

# 删掉所有源
gem rem --remove http://rubygems.org/

# 只用ruby-china的这个源，就能正常安装，其他好多源都失效了
gem rem --add https://gems.ruby-china.com/
```

再次安装，应该能正常装上了。

```
jekyll -v
# jekyll 4.1.1
```

如果找不到jeky命令，首先查找ruby/bin的目录,可以看到一堆地址找到对应的bin所在目录

```
gem env
# 从上面的回显中寻找bin目录，添加到path目录
export PATH=${PATH}:/usr/local/rvm/gems/ruby-2.7.0/bin
```

- [参考 VPS上使用nginx搭建jekyll blog（转移github博客）](http://elmagnifico.tech/2020/08/06/Jekyll-blog-nginx/)

# Nginx

当安装好jekyll环境以后，就可以正常的编译jekyll项目，然后需要使用nginx服务器将编译完成后的文件发布出去。

nginx需要依赖 openssl、pcre、zlib、gcc-c++，我使用的阿里云服务器已经提前安装好，这四个都可以使用yum命令进行安装。

```shell
 wget http://nginx.org/download/nginx-1.10.2.tar.gz
```

解压，编译安装：

```shell
tar zxvf nginx-1.10.2.tar.gz
cd nginx-1.10.2
./configure && make && make install
```

进入nginx安装路径：

```shell
whereis nginx # 找到路径
```

我的服务器是输出

```shell
/usr/local/nginx 
```

根据路径控制nginx

```shell
1.启动
/usr/local/nginx/sbin/nginx

2.停止 重启
/usr/local/nginx/sbin/nginx -s stop(quit、reload)

3.命令参考
/usr/local/nginx/sbin/nginx -h

4.验证配置文件
/usr/local/nginx/sbin/nginx -t

5.设置配置文件
vim /usr/local/nginx/conf/nginx.conf
```

此时便安装好了一个基本的nginx。

# 编译项目

首先使用git命令将自己的blog clone下来

```shell
git clone https://github.com/LostStarTvT/lostStarTvT.github.io.git
```

使用jekyll进行编译源代码

```shell
jekyll build --source /usr/local/coding/lostStarTvT.github.io --destination /usr/local/nginx/html
```

--source 表示源代码的路径， --destination 表示编译的生成的文件存放到哪，现在设置的是直接编译生成到nginx服务器的静态文件目录下。

- 参考 [nginx linux详细安装部署教程](https://www.cnblogs.com/taiyonghai/p/6728707.html)

# 自动部署

虽然手动将源码上传到github，然后手动使git pull 命令下载最新的版本，然后在进行编译生成可以实现更新，但有些麻烦，接下来实现自动化部署。

首先是github的webhook功能，即当github项目更新的时候，可以自动向目标网站发送一个请求。

### 配置 Webhook

在 Github 仓库的项目界面，比如本博客项目 `https://github.com/LostStarTvT/lostStarTvT.github.io`，点击 Setting->Webhooks->Add Webhook，在添加 Webhooks 的配置信息，我的配置信息如下：

```
Payload URL: http://www.ityouknow.com/deploy
Content type: application/json
Secret: 123456
```

如下图：

![img](http://favorites.ren/assets/images/2018/it/webhook.png)

### 服务器接受推送

我们需要在博客的服务器上面建立一个服务，来接收 Github 提交代码后的推送，从而来触发部署的脚本。 Github 上有一个开源项目可以做这个事情 [github-webhook-handler](https://github.com/rvagg/github-webhook-handler)。

这个开源项目目的很单纯，就是负责接收 Github 推送过来的通知，然后执行部署脚本，不过他是使用 NodeJs 来开发的，所以我们先需要在 Centos 上面按照 Node 环境。

centos7 安装 Node 环境

首先添加源

```shell
sudo rpm -ivh https://dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/epel-release-7-11.noarch.rpm

//yum安装node.js
yum install -y nodejs
```

然后在安装 github-webhook-handler

```shell
npm install -g github-webhook-handler     #安装 github-webhook-handler

#如果没有安装成功，可以选择法2来安装
npm install -g cnpm --registry=http://r.cnpmjs.org
cnpm install -g github-webhook-handler
```

安装成功之后，我们需要添加一个脚本。进入到安装目录下：

```shell
cd  /usr/lib/node_modules/github-webhook-handler
```

新建 deploy.js

```shell
vi deploy.js
```

脚本内容如下：

/usr/lib/node_modules/github-webhook-handler/delpoy.js

```shell
var http = require('http')
var createHandler = require('github-webhook-handler')
var handler = createHandler({ path: '/deploy', secret: 'ityouknow' }) //监听请求路径，和Github 配置的密码
 
function run_cmd(cmd, args, callback) {
  var spawn = require('child_process').spawn;
  var child = spawn(cmd, args);
  var resp = "";
 
  child.stdout.on('data', function(buffer) { resp += buffer.toString(); });
  child.stdout.on('end', function() { callback (resp) });
}
 
http.createServer(function (req, res) {
  handler(req, res, function (err) {
    res.statusCode = 404
    res.end('no such location')
  })
}).listen(3006)//监听的端口
 
handler.on('error', function (err) {
  console.error('Error:', err.message)
})
 
handler.on('push', function (event) {
  console.log('Received a push event for %s to %s',
    event.payload.repository.name,
    event.payload.ref);
  run_cmd('sh', ['/usr/local/depoly.sh'], function(text){ console.log(text) });//成功后，执行的脚本。
})
```

脚本的作业就是启动一个监听端口来接收请求，接收到请求后执行部署脚本，脚本内容的关键点已经标注上注释。

部署博客的脚本如下：depoly.sh

/usr/local/depoly.sh 

```shell
echo `date`
cd /usr/local/coding/lostStarTvT.github.io 
echo start pull from github 
git pull https://github.com/LostStarTvT/lostStarTvT.github.io.git
echo start build..
jekyll build --source /usr/local/coding/lostStarTvT.github.io --destination /usr/local/nginx/html
```

就是拉取代码，进行部署而已。

这个脚本的启动需要借助 Node 中的一个管理 forever 。forever 可以看做是一个 nodejs 的守护进程，能够启动，停止，重启我们的 app 应用。

不过我们的先安装 forever，然后需要使用 forever 来启动 deploy.js 的服务，执行命令如下：

```shell
首先进入deploy.js 所在的目录： cd  /usr/lib/node_modules/github-webhook-handler

npm install forever -g   #安装
$ forever start deploy.js          #启动
$ forever stop deploy.js           #关闭
$ forever start -l forever.log -o out.log -e err.log deploy.js   

#输出日志和错误
/root/node-v8.12.0-linux-x64/lib/node_modules/forever/bin/forever start -l forever.log -o out.log -e err.log deploy.js

如果报错：
/root/node-v8.12.0-linux-x64/lib/node_modules/forever/bin/forever start -a -l forever.log -o out.log -e err.log deploy.js
```

同时一般情况下，我们不会对外保留很多端口，所以需要通过博客的地址来转发，需要在 Nginx 上面添加一个转发配置，用来监听的 /deploy 请求转发到 nodejs 服务上，配置代码如下：

```shell
location = /deploy {
     proxy_pass http://127.0.0.1:3006/deploy;
}
```

这样我们整个自动化部署就完了，每次提交代码时，Github 会发送 Webhook 给地址`http://www.ityouknow.com/deploy`，Nginx 将 `/deploy` 地址转发给 Nodejs 端口为 3306 的服务，最后通过 github-webhook-handler 来执行部署脚本，已到达自动部署的目的。

以后只需要我们提交代码到 Github ,就会自动触发博客的自动化部署。



主要也就是有两个文件

- /usr/lib/node_modules/github-webhook-handler/delpoy.js  监听3006端口的nodejs脚本
- /usr/local/depoly.sh  自动拉起git 然后进行编译的脚本。

但是因为我还没有备份，所以还不能测试能否争取的实现。 但是想在还没有想好如何实现。



- 参考： [技术人如何利用github+jekyll 搭建一个独立免费的技术博客](https://www.cnblogs.com/ityouknow/p/11904647.html)